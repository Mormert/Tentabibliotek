(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{"7pcG":function(e,t,r){"use strict";r.d(t,"a",(function(){return R})),r.d(t,"b",(function(){return N}));var n=r("D57K"),a=r("wHJ2"),o=r("nbDY"),i=r.n(o),s=r("Sa5G"),u=r("0JpG"),l=r("fYJU"),c=r("go4a"),d=r("VdDF"),f=r("jhBu"),h=r("P2dS"),m=r("pjml"),p=r("wgY5"),y=r("A0nf"),v=r("8jzW"),I=r("TnpK"),S=r("vhkR"),C=r("Is+C"),g=r("z6Q5"),R="ultra.components.services.calendar",N="bbCalendar",T=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Object(n.__extends)(t,e),t.Institution=new t("Institution"),t.Personal=new t("Personal"),t.Course=new t("Course"),t.ExternalCourse=new t("ExternalCourse"),t.OfficeHoursForAllCourses=new t("OfficeHoursForAllCourses"),t}(i.a),b=function(){function e(e,t,r,n,a,o,i,s,u,l,c,d,f,h,m){this.$q=e,this.batchService=t,this.localize=r,this.contextUser=n,this.CourseModel=a,this.CourseMembershipModel=o,this.ExternalCourseModel=i,this.InstitutionCalendarItemModel=s,this.UserModel=u,this.entitlementService=l,this.categoryService=c,this.scoreProviderHelper=d,this.ultraState=f,this.ltiService=h,this.scormService=m}return e.prototype.mixinColorIndexToCalendarItems=function(e,t){var r=this,n={};e.forEach((function(e){var t=e.calendarId;(n[t]=n[t]||[]).push(e)}));var a=n[m.h.KnownCalendar.INSTITUTION.toString()];a&&a.forEach((function(e){e.ui.courseColorClass="institution-color"}));var o=n[m.h.KnownCalendar.PERSONAL.toString()];o&&o.forEach((function(e){e.ui.courseColorClass="personal-color"}));var i=[];return this.batchService.performBatch((function(){Object.keys(n).filter((function(e){return!m.h.KnownCalendar.parse(e)})).forEach((function(e){i.push(r.CourseModel.$new(e).users.$find(t).$asPromise())}))})),this.$q.all(i).then((function(e){e.forEach((function(e){var t=n[e.course.$pk];if(t){var r=c.a(e);t.forEach((function(e){e.ui.courseColorClass=r}))}}))})).then((function(){return e}))},e.prototype.updateCalendarItemTime=function(e,t,r){var a=this.getCalendarItem({calendarId:e.calendarId,itemSourceId:e.itemSourceId,itemSourceType:e.itemSourceType,repeatRuleType:e.recurRules&&e.recurRules.repeatRuleType,repeatRuleCourseId:e.recurRules&&e.recurRules.repeatRuleCourseId,repeatRuleUserId:e.recurRules&&e.recurRules.repeatRuleUserId});e.recurRules&&e.recurRules.repeatRuleType?(a.startDate=new Date(t.getTime()-e.startDate.getTime()+e.recurRules.originalStart.getTime()),a.endDate=new Date(r.getTime()-e.endDate.getTime()+e.recurRules.originalEnd.getTime())):(a.startDate=t,a.endDate=r);var o=["startDate","endDate"];return e.recurRules&&(a.recurRules=Object(n.__assign)(Object(n.__assign)({},e.recurRules),{count:e.recurRules.count>=0?e.recurRules.count:null,originalStart:a.startDate,originalEnd:a.endDate,timeZoneId:d.a.getCurrentTimeZoneId()}),Object.keys(a.recurRules).forEach((function(e){o.push("recurRules."+e)}))),a.$save(o).$asPromise()},e.prototype.findCalendarItem=function(e){return this.getCalendarItem(e).$fetch().$asPromise()},e.prototype.getCalendarItem=function(e){var t={itemSourceId:e.itemSourceId,itemSourceType:e.itemSourceType};return m.h.KnownCalendar.INSTITUTION.isEqualTo(e.calendarId)?this.InstitutionCalendarItemModel.$new(t):m.i.RepeatRuleType.OfficeHours.isEqualTo(e.repeatRuleType)?this.CourseModel.$new(e.repeatRuleCourseId).users.$new(e.repeatRuleUserId).officeHours.$new(t):m.h.KnownCalendar.PERSONAL.isEqualTo(e.calendarId)?this.UserModel.$new(this.contextUser.userId).calendarItems.$new(t):m.i.RepeatRuleType.ClassSchedule.isEqualTo(e.repeatRuleType)?this.CourseModel.$new(e.calendarId).schedule.$new(t):this.CourseModel.$new(e.calendarId).calendars.calendarItems.$new(t)},e.prototype.getNextEventForDailyRepeat=function(e,t){if(!e||!m.i.RecurFrequency.Daily.isEqualTo(e.freq))return null;var r=e.interval;if(null==r&&(r=1),Number.isNaN(Number(r))||r!==Math.floor(r)||r<1||r>100)return null;var n=p(e.originalStart),a=p(t);a.hours(n.hours()).minutes(n.minutes()).seconds(n.seconds()).milliseconds(n.milliseconds());var o=a.diff(n,"days"),i=Math.floor(o/r);i*r!==o&&(a.add({days:(i+1)*r-o}),i++),i++;var s=!1;if(e.endsBy)s=e.until&&a.isBefore(e.until);else{var u=e.count;u>0&&u===Math.floor(u)&&(s=i<=e.count)}return s?a.toDate():null},e.prototype.getNextEventForMonthlyRepeat=function(e,t){if(!e||!m.i.RecurFrequency.Monthly.isEqualTo(e.freq))return null;var r=e.monthRepeatBy?this.getNextEventForByMonthDayRepeat(e,t):this.getNextEventForBySetPosRepeat(e,t);if(!r)return null;var n=e.monthRepeatBy?this.getNextEventForByMonthDayRepeat(e,e.originalStart):this.getNextEventForBySetPosRepeat(e,e.originalStart);if(!n)return null;var a=!1;if(e.endsBy)a=e.until&&r.isBefore(e.until);else{var o=e.count,i=e.interval;if(null==i&&(i=1),Number.isNaN(Number(i))||i!==Math.floor(i)||i<1||i>100)return null;o>0&&o===Math.floor(o)&&(a=e.monthRepeatBy&&e.byMonthDay>28?this.isWithinOccurrences(n,r,e.byMonthDay,o,i):r.diff(n,"months")<(o-1)*i+1)}return a?r.toDate():null},e.prototype.getNextEventForByMonthDayRepeat=function(e,t){var r=e.byMonthDay;if(Number.isNaN(Number(r))||r!==Math.floor(r)||r<=0||r>31)return null;var n=e.interval||1;if(Number.isNaN(Number(n))||n!==Math.floor(n))return null;var a=p(e.originalStart),o=p(t);o.hours(a.hours()).minutes(a.minutes()).seconds(a.seconds()).milliseconds(a.milliseconds());var i=o.date();o.date(1),i>r&&o.add({months:1});var s=a.clone().date(1),u=o.diff(s,"months"),l=Math.floor(u/n);u!==n*l&&o.add({months:(l+1)*n-u});for(var c=0;c<6;c++){if(o.clone().endOf("month").date()>=r)return o.date(r);o.add({months:n})}return null},e.prototype.getNextEventForBySetPosRepeat=function(e,t){var r=m.i.RecurWeekDay.parse(e.byDay),n=e.bySetPos;if(!r||Number.isNaN(Number(n))||n!==Math.floor(n)||0===n||n<-1||n>4)return null;var a,o,i=p(e.originalStart),s=p(t),u=s.date();return s.date(1).hours(i.hours()).minutes(i.minutes()).seconds(i.seconds()).milliseconds(i.milliseconds()),n>0?(a=s.day(),(o=r.dayOfWeek-a)<0&&(o+=7),o+=7*(n-1),s.add({days:o})):(s.add({months:1}),a=s.day(),(o=r.dayOfWeek-a)>=0&&(o-=7),s.add({days:o})),s.date()>=u?s:this.getNextEventForBySetPosRepeat(e,s.date(1).add({months:1}).toDate())},e.prototype.isWithinOccurrences=function(e,t,r,n,a){if(e.isSame(t,"day")&&n>=1)return!0;for(var o=1,i=e.clone().date(1);o<n;){if(i.add({months:a}).endOf("month"),i.date()>=r&&(o++,i.date(r),!i.isBefore(t,"day")))return!0;i.date(1)}return!1},e.prototype.getSampleDateForDayOfWeek=function(e){return Number.isNaN(Number(e))||e!==Math.floor(e)||e<0||e>6?null:new Date(2015,3,5+e)},e.prototype.mixinMetadataToCalendarItems=function(e,t){var r=this,n={};e.forEach((function(e){var t;t=m.h.KnownCalendar.PERSONAL.isEqualTo(e.calendarId)?e.recurRules&&m.i.RepeatRuleType.OfficeHours.isEqualTo(e.recurRules.repeatRuleType)?T.OfficeHoursForAllCourses.toString():e.recurRules&&m.i.RepeatRuleType.ExternalCourseSchedule.isEqualTo(e.recurRules.repeatRuleType)?T.ExternalCourse.toString():T.Personal.toString():m.h.KnownCalendar.INSTITUTION.isEqualTo(e.calendarId)?T.Institution.toString():T.Course.toString(),n[t]=n[t]||[],n[t].push(e)}));var a=[];a.push(this.localize.loadBundle("components/services/calendar").then((function(){var e=n[T.OfficeHoursForAllCourses.toString()];e&&e.forEach((function(e){e.ui.calendarName=r.localize.translateSync({locale:t,key:"components.services.calendar.allCourses"})}));var a=n[T.Personal.toString()];a&&a.forEach((function(e){e.ui.calendarName=r.localize.translateSync({locale:t,key:"components.services.calendar.personal"})}));var o=n[T.Institution.toString()];o&&o.forEach((function(e){e.ui.calendarName=r.localize.translateSync({locale:t,key:"components.services.calendar.institution"})}))})));var o=n[T.Course.toString()];o&&o.forEach((function(e){e.calendarNameLocalizable&&e.calendarNameLocalizable.rawValue&&(e.ui.calendarName=e.calendarNameLocalizable.rawValue,e.ui.linkType=m.i.MetadataOnCalendarItemCardLinkType.Course)}));var i=n[T.ExternalCourse.toString()];return i&&a.push(this.batchService.performBatch((function(){return r.$q.all(i.map((function(e){return r.ExternalCourseModel.$new(e.recurRules.repeatRuleExternalCourseId).$fetch().$asPromise()})))})).then((function(e){e.forEach((function(e){i.forEach((function(t){t.ui.calendarName=e.title,t.ui.linkType=m.i.MetadataOnCalendarItemCardLinkType.External,t.ui.externalCourseUrl=e.url}))}))}))),this.$q.all(a)},e.prototype.calculateDateToPersist=function(e,t,r){if(e&&p(t).isSame(r,"day"))return t;if(e){var n=p(r).clone().toDate();return n.setHours(t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()),n}return r},e.prototype.viewDueCalendarItem=function(e){var t=this;e&&e.isDueItem()&&this.CourseModel.$new(e.calendarId).$fetch().$then((function(r){if(r.isUltra())r.gradebook.columns.$new(e.itemSourceId).$fetch({expand:"collectExternalSubmissions"}).$then((function(e){if(e.isOffline())t.entitlementService.hasCourseEntitlement(s.v.ModifyGradebook,r.id).then((function(n){n&&t.ultraState.goPeekState("gradebook-item.offline",{columnId:e.id,courseId:r.id,gradeitemView:"students"})}));else{var n=y.a.parse(e.scoreProviderHandle.toString());if(n){var a=n.getContentHandlers()[0];t.ltiService.isLTILink(e)?t.ltiService.ltiLaunch({courseId:e.courseId,contentId:e.contentId,linkType:s.g.parse(e.scoreProviderHandle.toString()),linkRefId:e.linkId}):e.isScorm()?t.scormService.scormLaunch({courseId:e.courseId,contentId:e.contentId,showPreLaunchPanel:!0}):t.scoreProviderHelper.openStateRef(a,{isCollectExternalSubmissions:e.isCollectExternalSubmissions(),contentId:e.contentId,courseId:r.id},v.a.GoToState)}}}));else{var n=e.permissions&&e.permissions.edit;t.ultraState.goPeekState("course.outline",{courseId:r.id,legacyUrl:n?"/webapps/calendar/launch/modify/_"+e.itemSourceType+"-"+e.itemSourceId:"/webapps/calendar/launch/attempt/_"+e.itemSourceType+"-"+e.itemSourceId})}}))},e.prototype.getCalendarItemIcon=function(e){var t=this;if(!e.dynamicCalendarItemProps)return this.$q.when("");var r=e.dynamicCalendarItemProps,n=r.categoryId,a=r.handle;return this.categoryService.getOrLoadCategoriesForCourse(e.calendarId).then((function(e){var r="",o=e.find((function(e){return e.id===n}));return o?r=t.categoryService.getCategoryIcon(o):a&&(r=y.a.parse(a).iconClass),t.$q.when(r)}))},e.$inject=["$q",g.b,u.serviceName,l.b,m.o.serviceName,m.v.serviceName,m.B.serviceName,m.L.serviceName,m.Qb.serviceName,f.b,h.b,v.c,I.d,S.c,C.c],e}();!function(e){function t(){return null!==e&&e.apply(this,arguments)||this}Object(n.__extends)(t,e)}(b);a.module(R,[g.a,u.moduleName,l.a,m.R,h.a,v.b,I.b,S.b,C.b]).service(N,b)}}]);